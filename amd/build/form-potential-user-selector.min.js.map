{"version":3,"file":"form-potential-user-selector.min.js","sources":["../src/form-potential-user-selector.js"],"sourcesContent":["// This file is part of the tool_certificate plugin for Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * User selector form on modal based on form-potential-user-selector 2016 Damyon Wiese.\n *\n * @module     tool_certificate/form-potential-user-selector\n * @copyright  2018 David Matamoros <davidmc@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'core/templates', 'core/str'], function($, Ajax, Templates, Str) {\n\n    // Maximum number of users to show.\n    var MAXUSERS = 100;\n\n    return {\n\n        processResults: function(selector, results) {\n            var users = [];\n            if ($.isArray(results)) {\n                $.each(results, function(index, user) {\n                    users.push({\n                        value: user.id,\n                        label: user._label\n                    });\n                });\n                return users;\n\n            } else {\n                return results;\n            }\n        },\n\n        transport: function(selector, query, success, failure) {\n            var promise;\n            promise = Ajax.call([{\n                methodname: 'tool_certificate_potential_users_selector',\n                args: {\n                    search: query,\n                    itemid: $(selector).data('itemid'),\n                }\n            }]);\n            promise[0].then(function(results) {\n                var promises = [],\n                    i = 0;\n                if (results.length <= MAXUSERS) {\n                    // Render the label.\n                    $.each(results, function(index, user) {\n                        var ctx = user,\n                            identity = [];\n                        $.each(['idnumber', 'email', 'phone1', 'phone2', 'department', 'institution'], function(i, k) {\n                            if (typeof user[k] !== 'undefined' && user[k] !== '') {\n                                ctx.hasidentity = true;\n                                identity.push(user[k]);\n                            }\n                        });\n                        ctx.identity = identity.join(', ');\n                        promises.push(Templates.render('tool_certificate/form-user-selector-suggestion', ctx));\n                    });\n\n                    // Apply the label to the results.\n                    // TODO WP-4426 fix properly.\n                    /* eslint-disable-next-line promise/no-nesting */\n                    return $.when.apply($.when, promises).then(function() {\n                        var args = arguments;\n                        $.each(results, function(index, user) {\n                            user._label = args[i];\n                            i++;\n                        });\n                        success(results);\n                        return;\n                    });\n\n                } else {\n                    // TODO WP-4426 fix properly.\n                    /* eslint-disable-next-line promise/no-nesting */\n                    return Str.get_string('toomanyuserstoshow', 'core', '>' + MAXUSERS).then(function(toomanyuserstoshow) {\n                        success(toomanyuserstoshow);\n                        return;\n                    });\n                }\n\n            }).fail(failure);\n        }\n    };\n});\n"],"names":["define","$","Ajax","Templates","Str","processResults","selector","results","users","isArray","each","index","user","push","value","id","label","_label","transport","query","success","failure","call","methodname","args","search","itemid","data","then","promises","i","length","ctx","identity","k","hasidentity","join","render","when","apply","arguments","get_string","toomanyuserstoshow","fail"],"mappings":";;;;;;;AAuBAA,uDAAO,CAAC,SAAU,YAAa,iBAAkB,aAAa,SAASC,EAAGC,KAAMC,UAAWC,WAKhF,CAEHC,eAAgB,SAASC,SAAUC,aAC3BC,MAAQ,UACRP,EAAEQ,QAAQF,UACVN,EAAES,KAAKH,SAAS,SAASI,MAAOC,MAC5BJ,MAAMK,KAAK,CACPC,MAAOF,KAAKG,GACZC,MAAOJ,KAAKK,YAGbT,OAGAD,SAIfW,UAAW,SAASZ,SAAUa,MAAOC,QAASC,SAEhCnB,KAAKoB,KAAK,CAAC,CACjBC,WAAY,4CACZC,KAAM,CACFC,OAAQN,MACRO,OAAQzB,EAAEK,UAAUqB,KAAK,cAGzB,GAAGC,MAAK,SAASrB,aACjBsB,SAAW,GACXC,EAAI,SACJvB,QAAQwB,QAhCT,KAkCC9B,EAAES,KAAKH,SAAS,SAASI,MAAOC,UACxBoB,IAAMpB,KACNqB,SAAW,GACfhC,EAAES,KAAK,CAAC,WAAY,QAAS,SAAU,SAAU,aAAc,gBAAgB,SAASoB,EAAGI,QAChE,IAAZtB,KAAKsB,IAAkC,KAAZtB,KAAKsB,KACvCF,IAAIG,aAAc,EAClBF,SAASpB,KAAKD,KAAKsB,QAG3BF,IAAIC,SAAWA,SAASG,KAAK,MAC7BP,SAAShB,KAAKV,UAAUkC,OAAO,iDAAkDL,SAM9E/B,EAAEqC,KAAKC,MAAMtC,EAAEqC,KAAMT,UAAUD,MAAK,eACnCJ,KAAOgB,UACXvC,EAAES,KAAKH,SAAS,SAASI,MAAOC,MAC5BA,KAAKK,OAASO,KAAKM,GACnBA,OAEJV,QAAQb,aAOLH,IAAIqC,WAAW,qBAAsB,OAAQ,QAAgBb,MAAK,SAASc,oBAC9EtB,QAAQsB,0BAKjBC,KAAKtB"}